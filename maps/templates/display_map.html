{% extends "base.html" %}
{% block title %}{{ block.super }} :: map{% endblock %}

{% block js %}
    {{ block.super }}
    {% load static %}
    <script src="{% get_static_prefix %}openlayers/lib/OpenLayers.js"></script>
    <script src="{% get_static_prefix %}openlayers/InlineXhtml/lib/OpenLayers/Tile/InlineXhtml.js"></script>
    <script src="{% get_static_prefix %}openlayers/InlineXhtml/lib/OpenLayers/Layer/WMS/InlineXhtml.js"></script>
    <script src="{% get_static_prefix %}openlayers/InlineXhtml/lib/OpenLayers/Layer/InlineXhtml.js"></script>
    <script src="{% get_static_prefix %}openlayers/InlineXhtml/lib/OpenLayers/Layer/ScalableInlineXhtml.js"></script>
    <script src="{% get_static_prefix %}js/heatmap.js"></script>
    <script type="text/javascript">
// variable to keep track of the last time we received data
// a time value will be sent back with the response in a unix timestamp format
var lastupdate = 0;
// times in milliseconds
var basemap_poll_timeout = 2000;
var basemap_retry_timeout = 10000;
var basemap_error_timeout = 300000;
var heatmap_poll_timeout = 1000;
var heatmap_retry_timeout = basemap_retry_timeout;
var heatmap_error_timeout = basemap_error_timeout;

var heatmap_intensity = 0.08;
var heatmap_default_opacity = 0.6;
var heatmap_scaling_factor = 25;

var heatmap_metadata;
var basemap_metadata;

var delay = 0;
var delta_delay = 500;

$(document).ready(function(){
    get_basemap_status();
});

function get_basemap_status() {
    $.ajax({
        dataType: "json",
        type: "GET",
        url: '{% url maps.views.basemap_metadata data.basemap_id %}',
        async: true,
        cache: false,
        timeout:basemap_error_timeout,
        success: function(data) {
            basemap_metadata = data;
            $('#status').text(basemap_metadata.status);
            if (basemap_metadata.finished) {
                $('#status').hide();
                display_basemap("{% url maps.views.basemap data.basemap_id %}", basemap_metadata.width, basemap_metadata.height);
            }
            else {
                setTimeout(get_basemap_status, basemap_poll_timeout);
            }
        },
        // handle error
        error: function(XMLHttpRequest, textStatus, errorThrown){
            // try again in 10 seconds if there was a request error
            setTimeout(get_basemap_status, basemap_retry_timeout);
        },
    });
}

function get_heatmap_status() {
    $.ajax({
        type: "GET",
        url: '{% url maps.views.heatmap_metadata data.heatmap_id %}',
        async: true,
        cache: false,
        timeout: heatmap_error_timeout,
        success: function(data) {
            heatmap_metadata = data;
            if (heatmap_metadata.finished) {
                display_heatmap('{% url maps.views.heatmap data.heatmap_id %}');
            }
            else {
                setTimeout(get_heatmap_status, heatmap_poll_timeout);
            }
        },
        error: function(XMLHttpRequest, textStatus, errorThrown){
            setTimeout(get_heatmap_status, heatmap_retry_timeout);
        },
    });
}

OpenLayers.ImgPath = "http://js.mapbox.com/theme/dark/";
var map; //OpenLayers.Map
var heatmap;

function get_node(text) {
    return $(".node").filter(function() {
            return $(this).children('title').text() == text;
            })
}

function highlight_terms(term_list) {
    /* term_list should be list of { term:"term", radius:r, intensity:i } objects*/
    var scaling_factor = term_list.map(function(d) { return Math.log(d.intensity); })
        .reduce(function(p, c) { return Math.max(p,c); });
    console.debug(scaling_factor);
    var svg = $('svg');
    // avoid race condition: check if svg has been initialized yet before trying to draw terms
    if (svg.length == 0) {
        delay += delta_delay;
        setTimeout(highlight_terms, delay, term_list)
    }
    else {
        term_list.map(function (term) {
                highlight_node(term.term, term.radius, Math.log(term.intensity) / scaling_factor);
                });
        rescale_heatmap();
    }
}

var ctm;
function highlight_node(name, radius, intensity) {
    var svg = $('svg')[0];
    var pt = svg.createSVGPoint();
    var node = get_node(name);
    if (node.length > 0) {
        var text_element = node.children('text').first();
        var x = text_element.attr('x');
        var y = text_element.attr('y');
        pt.x = x;
        pt.y = y;
        if (ctm == null) {
            var txt = text_element[0];
            ctm = txt.getTransformToElement(svg);
        }
        var transformed_point = pt.matrixTransform(ctm);
        heatmap.addSource(new Heatmap.Source(new OpenLayers.LonLat(transformed_point.x, -1*transformed_point.y), radius, intensity));
        }
    else {
        console.debug('node not found:');
        console.debug(name);
    }
}

function rescale_heatmap() {
    heatmap.defaultRadius = heatmap_scaling_factor * map.zoom;
    heatmap.redraw();
}

function display_basemap(basemap_url, width, height) {
    var bounds = new OpenLayers.Bounds(0, -1 * height, width, 0);
    map_options = {
        controls:[
            new OpenLayers.Control.Navigation(),
            new OpenLayers.Control.PanZoomBar(),
            new OpenLayers.Control.LayerSwitcher(),
            new OpenLayers.Control.Attribution()
                ],
        maxExtent: bounds,
        //minExtent: new OpenLayers.Bounds(0, -1 * height/2, width/2, 0),
        numZoomLevels: 8,
        fractionalZoom: true,
    }
    map = new OpenLayers.Map ("map", map_options);
    var mocs = new OpenLayers.Layer.ScalableInlineXhtml(
        "MoCS",
        basemap_url,
        bounds,
        null,
        {isBaseLayer: true,
            opacity: '1.0'}
    );
    var svg = $('svg');
    mocs.adjustBounds(bounds);
    heatmap = new Heatmap.Layer("Heatmap");
    heatmap.defaultRadius = heatmap_scaling_factor;
    heatmap.defaultIntensity = heatmap_intensity;
    heatmap.setOpacity(heatmap_default_opacity);
    map.addLayers([mocs, heatmap]);
    map.zoomToExtent(bounds);
    map.events.on({ 
            "zoomend": rescale_heatmap,
            });

    var ov_options = {
              //layers: [mocs],
            };
    overview = new OpenLayers.Control.OverviewMap(ov_options);
    overview.size.w = 160;
    overview.size.h = 120;
    //map.addControl(overview);

    $("#intensity-slider").slider({
        min: 0.0,
        max: 0.5,
        step: 0.01,
        value: heatmap.defaultIntensity,
        change: function(event, ui) {
            heatmap.defaultIntensity = ui.value;
            heatmap.redraw();
    }
    });
    $("#opacity-slider").slider({
    min: 0,
    max: 1,
    step: 0.01,
    value: heatmap_default_opacity,
    change: function(event, ui) {
        heatmap.setOpacity(ui.value);
        }
    });
    get_heatmap_status();
} 

function display_heatmap(heatmap_url) {
    $.ajax({
        dataType: "json",
        type: "GET",
        url: heatmap_url,
        async: true,
        cache: false,
        timeout:heatmap_error_timeout,
        success: function(heatmap_data) {
            highlight_terms(heatmap_data);
        },
        error: function(XMLHttpRequest, textStatus, errorThrown){
            // try again in 10 seconds if there was a request error
            setTimeout(get_heatmap_status, heatmap_retry_timeout);
        },
    });
}
</script>
{% endblock %}

{% block content %}
    <div id='status'></div>
    <div id='map' style='height:1200px'></div>

    heatmap opacity
    <div id='opacity-slider' style='margin:1em'></div>
    heatmap intensity
    <div id='intensity-slider' style='margin:1em'></div>
{% endblock %}
